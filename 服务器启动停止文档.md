# MapleStory Server 079 - 服务器启动和停止文档

## 目录
- [快速开始](#快速开始)
- [启动服务器](#启动服务器)
- [停止服务器](#停止服务器)
- [重启服务器](#重启服务器)
- [检查服务状态](#检查服务状态)
- [日志管理](#日志管理)
- [故障排查](#故障排查)
- [服务管理脚本](#服务管理脚本)

---

## 快速开始

### 一键启动
```bash
./start.sh
```

### 一键停止
```bash
pkill -f "maple.jar"
```

### 查看状态
```bash
ps aux | grep maple.jar | grep -v grep
```

---

## 启动服务器

### 前置条件检查

启动服务器前，确保以下服务已就绪：

#### 1. 检查MySQL服务
```bash
service mysql status
```

如果MySQL未运行，启动MySQL：
```bash
service mysql start
```

#### 2. 检查Java环境
```bash
java -version
```

应显示Java版本信息（推荐Java 8）。

#### 3. 检查编译文件
```bash
ls -lh bin/maple.jar
```

确保 `bin/maple.jar` 文件存在（大小约1.8MB）。

### 启动方式

#### 方式一：前台启动（推荐用于调试）

```bash
./start.sh
```

**特点：**
- 日志直接输出到终端
- 按 `Ctrl+C` 停止服务
- 关闭终端窗口服务会停止

**适用场景：**
- 开发调试
- 查看实时日志
- 快速测试

#### 方式二：后台启动（推荐用于生产）

```bash
nohup ./start.sh > logs/server.log 2>&1 &
```

**特点：**
- 服务在后台运行
- 日志输出到 `logs/server.log`
- 关闭终端窗口服务继续运行

**查看启动PID：**
```bash
echo "服务器PID: $!"
```

**适用场景：**
- 生产环境
- 长期运行
- 远程服务器

#### 方式三：使用screen（推荐用于远程管理）

```bash
# 安装screen（如果未安装）
apt-get install screen

# 创建新的screen会话
screen -S maplestory

# 在screen中启动服务器
./start.sh

# 按 Ctrl+A 然后按 D 脱离screen会话
# 服务器继续在后台运行

# 重新连接到screen会话
screen -r maplestory

# 查看所有screen会话
screen -ls
```

**特点：**
- 可以随时查看日志
- 终端断开不影响服务
- 方便远程管理

### 启动过程说明

服务器启动需要30-60秒，启动过程包括：

1. **加载配置文件** (2-3秒)
   - 读取 `config/server.properties`
   - 读取 `config/db.properties`

2. **连接MySQL数据库** (3-5秒)
   - 建立数据库连接池
   - 加载游戏数据

3. **启动登录服务器** (5-10秒)
   - 绑定端口 1314 (或 7575)
   - 初始化认证系统

4. **启动频道服务器** (20-30秒)
   - 启动6个游戏频道（端口2525-2530）
   - 加载地图数据
   - 加载NPC数据（1553个）
   - 加载怪物数据
   - 加载掉落数据

5. **启动商城服务器** (5-10秒)
   - 绑定端口 8600
   - 加载商城物品

6. **加载脚本** (10-20秒)
   - 加载NPC脚本
   - 加载任务脚本
   - 加载事件脚本

### 启动成功标志

当看到以下信息时，表示启动成功：

```
频道 1: 端口 2525: IP 127.0.0.1:2525
频道 2: 端口 2526: IP 127.0.0.1:2526
频道 3: 端口 2527: IP 127.0.0.1:2527
频道 4: 端口 2528: IP 127.0.0.1:2528
频道 5: 端口 2529: IP 127.0.0.1:2529
频道 6: 端口 2530: IP 127.0.0.1:2530
商城: 端口 8600
```

---

## 停止服务器

### 方式一：使用pkill（推荐）

```bash
pkill -f "maple.jar"
```

**说明：**
- 安全关闭所有maple.jar进程
- 自动保存数据
- 等待3-5秒让进程正常退出

### 方式二：使用kill

#### 1. 查找进程ID
```bash
ps aux | grep maple.jar | grep -v grep
```

输出示例：
```
root  101434  19.7  7.4  12783568 955972  ...  server.Start
```

第二列是PID（进程ID），如：101434

#### 2. 终止进程
```bash
kill 101434
```

或强制终止：
```bash
kill -9 101434
```

**注意：** `kill -9` 是强制终止，可能导致数据未保存，仅在服务无响应时使用。

### 方式三：在前台运行时停止

如果服务器在前台运行，直接按：
```
Ctrl + C
```

### 验证停止

```bash
ps aux | grep maple.jar | grep -v grep
```

如果没有输出，说明服务已停止。

### 停止前的注意事项

1. **通知玩家**
   - 提前在游戏内公告
   - 建议提前5-10分钟通知

2. **保存数据**
   - 正常停止会自动保存
   - 强制停止可能丢失数据

3. **备份数据库**（可选）
   ```bash
   mysqldump -uroot -pafauria maplestory_079 > backup_before_shutdown.sql
   ```

---

## 重启服务器

### 完整重启流程

```bash
# 1. 停止服务器
pkill -f "maple.jar"

# 2. 等待进程完全退出
sleep 5

# 3. 重启服务器
./start.sh
```

### 一键重启脚本

创建 `restart.sh` 脚本：

```bash
#!/bin/bash
echo "正在停止服务器..."
pkill -f "maple.jar"

echo "等待进程退出..."
sleep 5

# 确认进程已停止
if ps aux | grep maple.jar | grep -v grep > /dev/null; then
    echo "警告：进程仍在运行，强制终止..."
    pkill -9 -f "maple.jar"
    sleep 2
fi

echo "正在启动服务器..."
nohup ./start.sh > logs/server.log 2>&1 &

echo "服务器PID: $!"
echo "重启完成！"
echo "查看日志: tail -f logs/server.log"
```

使用方法：
```bash
chmod +x restart.sh
./restart.sh
```

### 热重启（不停服更新配置）

**注意：** 需要修改代码支持，当前版本不支持热重启。

---

## 检查服务状态

### 检查进程状态

```bash
ps aux | grep maple.jar | grep -v grep
```

**输出说明：**
```
USER  PID  %CPU  %MEM  VSZ    RSS    ...  COMMAND
root  1234  19.7  7.4  12783568 955972  ...  java -cp ./bin/maple.jar ...
```

- **PID**: 进程ID
- **%CPU**: CPU使用率
- **%MEM**: 内存使用率
- **RSS**: 实际内存使用（KB）

### 检查端口监听

```bash
# 安装net-tools（如果未安装）
apt-get install net-tools

# 查看监听端口
netstat -tulpn | grep java
```

**应该看到的端口：**
- 1314 或 7575 (登录服务器)
- 2525-2530 (6个游戏频道)
- 8600 (商城服务器)

### 检查MySQL连接

```bash
mysql -uroot -pafauria maplestory_079 -e "SHOW PROCESSLIST;" | grep -v "show processlist"
```

应该看到来自服务器的连接。

### 检查日志输出

```bash
# 查看最后100行日志
tail -100 logs/server.log

# 实时查看日志
tail -f logs/server.log

# 查看错误日志
grep -i error logs/server.log | tail -20
```

### 完整状态检查脚本

创建 `status.sh` 脚本：

```bash
#!/bin/bash
echo "========================================"
echo "  MapleStory Server 079 - 状态检查"
echo "========================================"
echo

# 检查进程
echo "【1. 进程状态】"
if ps aux | grep maple.jar | grep -v grep > /dev/null; then
    echo "✓ 服务器正在运行"
    ps aux | grep maple.jar | grep -v grep | awk '{print "  进程ID:", $2, "  内存:", $6/1024"MB", "  CPU:", $3"%"}'
else
    echo "✗ 服务器未运行"
fi
echo

# 检查MySQL
echo "【2. MySQL状态】"
if service mysql status > /dev/null 2>&1; then
    echo "✓ MySQL服务正常"
    mysql -uroot -pafauria -e "SELECT VERSION();" 2>&1 | grep -v Warning | tail -1 | awk '{print "  版本:", $1}'
else
    echo "✗ MySQL服务未运行"
fi
echo

# 检查端口
echo "【3. 监听端口】"
if command -v netstat > /dev/null; then
    netstat -tulpn 2>/dev/null | grep java | awk '{print "  "$4}' | grep -o ":[0-9]*" | sort -u | tr '\n' ' '
    echo
else
    echo "  (需要安装net-tools查看端口: apt-get install net-tools)"
fi
echo

# 检查日志
echo "【4. 最近日志】"
if [ -f logs/server.log ]; then
    echo "  最后更新: $(date -r logs/server.log '+%Y-%m-%d %H:%M:%S')"
    echo "  文件大小: $(du -h logs/server.log | awk '{print $1}')"
    echo "  最近错误:"
    grep -i error logs/server.log | tail -3 | sed 's/^/    /'
else
    echo "  日志文件不存在"
fi

echo
echo "========================================"
```

使用方法：
```bash
chmod +x status.sh
./status.sh
```

---

## 日志管理

### 日志文件位置

| 日志类型 | 路径 | 说明 |
|---------|------|------|
| 服务器主日志 | `logs/server.log` | 所有服务器输出 |
| IP访问日志 | `logs/LogIPs.txt` | 玩家IP记录 |
| MySQL错误日志 | `/var/log/mysql/error.log` | 数据库错误 |
| MySQL慢查询 | `/var/log/mysql/slow.log` | 慢SQL查询 |

### 查看日志命令

```bash
# 查看最新日志
tail -f logs/server.log

# 查看最后100行
tail -100 logs/server.log

# 查看前100行
head -100 logs/server.log

# 搜索错误
grep -i error logs/server.log

# 搜索特定玩家
grep "角色名" logs/server.log

# 按时间查看
grep "2026-02-19" logs/server.log
```

### 日志清理

日志文件会不断增长，需要定期清理：

```bash
# 备份当前日志
mv logs/server.log logs/server_$(date +%Y%m%d_%H%M%S).log

# 压缩旧日志
gzip logs/server_*.log

# 删除30天前的日志
find logs/ -name "*.log.gz" -mtime +30 -delete

# 查看日志文件大小
du -sh logs/
```

### 日志分割脚本

创建 `logrotate.sh` 脚本：

```bash
#!/bin/bash
LOG_DIR="logs"
BACKUP_DIR="logs/archive"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 如果日志文件大于100MB，进行分割
if [ -f "$LOG_DIR/server.log" ]; then
    SIZE=$(du -m "$LOG_DIR/server.log" | awk '{print $1}')
    if [ $SIZE -gt 100 ]; then
        echo "日志文件过大($SIZE MB)，进行备份..."
        mv "$LOG_DIR/server.log" "$BACKUP_DIR/server_$DATE.log"
        gzip "$BACKUP_DIR/server_$DATE.log"
        echo "新日志文件已创建"

        # 删除90天前的备份
        find $BACKUP_DIR -name "*.log.gz" -mtime +90 -delete
    fi
fi
```

添加到定时任务（每天凌晨4点执行）：
```bash
chmod +x logrotate.sh
crontab -e
# 添加：
# 0 4 * * * /data/app/maple/MapleStory-Server-079/logrotate.sh
```

---

## 故障排查

### 服务器无法启动

#### 问题1：端口被占用
```bash
# 查看端口占用
netstat -tulpn | grep -E "1314|2525|8600"

# 如果被占用，找到占用进程并终止
lsof -i :1314
kill <PID>
```

#### 问题2：MySQL未连接
```bash
# 检查MySQL服务
service mysql status

# 启动MySQL
service mysql start

# 测试连接
mysql -uroot -pafauria maplestory_079 -e "SELECT 1;"
```

#### 问题3：内存不足
```bash
# 查看内存使用
free -h

# 如果内存不足，减小JVM内存配置
# 编辑 start.sh，将 -Xmx2048m 改小，如 -Xmx1024m
```

#### 问题4：maple.jar文件不存在
```bash
# 重新编译
./compile.sh
```

### 服务器突然停止

#### 检查1：查看最后日志
```bash
tail -100 logs/server.log
```

#### 检查2：系统日志
```bash
dmesg | tail -50
grep -i "out of memory" /var/log/syslog
```

#### 检查3：Java错误
```bash
grep -i "exception\|error" logs/server.log | tail -20
```

### 玩家无法连接

#### 检查1：服务器是否运行
```bash
ps aux | grep maple.jar
```

#### 检查2：端口是否开放
```bash
netstat -tulpn | grep 1314
```

#### 检查3：防火墙设置
```bash
# Ubuntu/Debian
ufw status
ufw allow 1314
ufw allow 2525:2530/tcp
ufw allow 8600

# CentOS
firewall-cmd --list-ports
firewall-cmd --add-port=1314/tcp --permanent
firewall-cmd --reload
```

#### 检查4：IP配置
```bash
# 查看配置的IP
grep "RoyMS.IP" config/server.properties

# 如果是127.0.0.1，只能本地连接
# 修改为服务器实际IP或0.0.0.0
```

### 数据库连接失败

#### 检查1：MySQL运行状态
```bash
service mysql status
```

#### 检查2：数据库存在
```bash
mysql -uroot -pafauria -e "SHOW DATABASES;" | grep maplestory_079
```

#### 检查3：用户权限
```bash
mysql -uroot -pafauria -e "SHOW GRANTS FOR 'root'@'localhost';"
```

#### 检查4：配置文件
```bash
cat config/db.properties
```

---

## 服务管理脚本

创建统一的管理脚本 `server.sh`：

```bash
#!/bin/bash

SERVER_NAME="MapleStory Server 079"
JAR_FILE="bin/maple.jar"
LOG_FILE="logs/server.log"
PID_FILE="server.pid"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 检查服务器状态
check_status() {
    if ps aux | grep "$JAR_FILE" | grep -v grep > /dev/null; then
        return 0
    else
        return 1
    fi
}

# 启动服务器
start() {
    echo -e "${YELLOW}正在启动 $SERVER_NAME...${NC}"

    # 检查MySQL
    if ! service mysql status > /dev/null 2>&1; then
        echo -e "${RED}错误: MySQL未运行，正在启动...${NC}"
        service mysql start
        sleep 3
    fi

    # 检查是否已运行
    if check_status; then
        echo -e "${YELLOW}服务器已经在运行中${NC}"
        return 1
    fi

    # 启动服务器
    nohup ./start.sh > "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"

    sleep 5

    if check_status; then
        echo -e "${GREEN}✓ 启动成功${NC}"
        echo "PID: $(cat $PID_FILE)"
        echo "日志: tail -f $LOG_FILE"
    else
        echo -e "${RED}✗ 启动失败，请检查日志${NC}"
        return 1
    fi
}

# 停止服务器
stop() {
    echo -e "${YELLOW}正在停止 $SERVER_NAME...${NC}"

    if ! check_status; then
        echo -e "${YELLOW}服务器未运行${NC}"
        return 1
    fi

    pkill -f "$JAR_FILE"

    # 等待进程退出
    for i in {1..10}; do
        sleep 1
        if ! check_status; then
            echo -e "${GREEN}✓ 停止成功${NC}"
            rm -f "$PID_FILE"
            return 0
        fi
    done

    # 强制终止
    echo -e "${YELLOW}正常停止超时，强制终止...${NC}"
    pkill -9 -f "$JAR_FILE"
    sleep 2

    if ! check_status; then
        echo -e "${GREEN}✓ 已强制停止${NC}"
        rm -f "$PID_FILE"
    else
        echo -e "${RED}✗ 停止失败${NC}"
        return 1
    fi
}

# 重启服务器
restart() {
    stop
    sleep 3
    start
}

# 查看状态
status() {
    echo "========================================"
    echo "  $SERVER_NAME - 状态"
    echo "========================================"

    if check_status; then
        echo -e "${GREEN}状态: 运行中${NC}"
        ps aux | grep "$JAR_FILE" | grep -v grep | awk '{print "PID: "$2", 内存: "$6/1024"MB, CPU: "$3"%"}'
    else
        echo -e "${RED}状态: 已停止${NC}"
    fi

    echo
    echo "MySQL: $(service mysql status > /dev/null 2>&1 && echo -e "${GREEN}运行中${NC}" || echo -e "${RED}已停止${NC}")"

    if [ -f "$LOG_FILE" ]; then
        echo "日志: $LOG_FILE ($(du -h $LOG_FILE | awk '{print $1}'))"
    fi
}

# 查看日志
logs() {
    if [ -f "$LOG_FILE" ]; then
        tail -f "$LOG_FILE"
    else
        echo "日志文件不存在"
    fi
}

# 主逻辑
case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs
        ;;
    *)
        echo "用法: $0 {start|stop|restart|status|logs}"
        echo ""
        echo "命令说明:"
        echo "  start   - 启动服务器"
        echo "  stop    - 停止服务器"
        echo "  restart - 重启服务器"
        echo "  status  - 查看状态"
        echo "  logs    - 查看日志"
        exit 1
        ;;
esac
```

使用方法：
```bash
chmod +x server.sh

./server.sh start    # 启动
./server.sh stop     # 停止
./server.sh restart  # 重启
./server.sh status   # 状态
./server.sh logs     # 日志
```

---

## 开机自启动

### 创建systemd服务（Ubuntu 22.04）

创建服务文件：`/etc/systemd/system/maplestory.service`

```ini
[Unit]
Description=MapleStory Server 079
After=mysql.service
Requires=mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/data/app/maple/MapleStory-Server-079
ExecStart=/usr/bin/java -cp ./bin/maple.jar -server -DhomePath=./config/ -DscriptsPath=./scripts/ -DwzPath=./scripts/wz -Xms512m -Xmx2048m -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m -XX:MaxNewSize=512m server.Start
ExecStop=/bin/kill -TERM $MAINPID
Restart=on-failure
RestartSec=10
StandardOutput=append:/data/app/maple/MapleStory-Server-079/logs/server.log
StandardError=append:/data/app/maple/MapleStory-Server-079/logs/server.log

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
systemctl daemon-reload
systemctl enable maplestory
systemctl start maplestory

# 管理命令
systemctl status maplestory
systemctl stop maplestory
systemctl restart maplestory
```

---

## 性能监控

### 实时监控CPU和内存

```bash
# 方式1：使用top
top -p $(pgrep -f maple.jar)

# 方式2：使用htop（需安装）
apt-get install htop
htop -p $(pgrep -f maple.jar)
```

### 监控脚本

创建 `monitor.sh`：

```bash
#!/bin/bash
while true; do
    clear
    echo "=== MapleStory Server Monitor ==="
    echo "时间: $(date '+%Y-%m-%d %H:%M:%S')"
    echo

    if ps aux | grep maple.jar | grep -v grep > /dev/null; then
        ps aux | grep maple.jar | grep -v grep | awk '{
            printf "进程状态: 运行中\n"
            printf "PID: %s\n", $2
            printf "CPU使用: %s%%\n", $3
            printf "内存使用: %.2f MB\n", $6/1024
            printf "运行时间: %s\n", $10
        }'
    else
        echo "进程状态: 未运行"
    fi

    echo
    echo "按 Ctrl+C 退出"
    sleep 5
done
```

---

**文档版本：** 1.0
**最后更新：** 2026-02-19
**适用版本：** MapleStory Server 079 / Java 8 / MySQL 8.0
